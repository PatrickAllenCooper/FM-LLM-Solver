{% extends "base.html" %}

{% block title %}FM-LLM Solver - Barrier Certificate Generation{% endblock %}

{% block content %}
<!-- Mode Selection -->
<div class="card mt-24">
    <h2 class="card-title">Choose Generation Mode</h2>
    <div style="display: flex; gap: 16px; margin-bottom: 16px;">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="radio" name="generation-mode" value="direct" checked>
            <span>Direct Generation</span>
        </label>
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="radio" name="generation-mode" value="conversation">
            <span>Conversational Mode</span>
        </label>
    </div>
    <p style="color: var(--md-sys-color-on-surface-variant); font-size: 14px;">
        <strong>Direct:</strong> Provide complete system description and generate immediately<br>
        <strong>Conversational:</strong> Discuss your system with the AI, refine the description, then generate
    </p>
</div>

<div class="grid grid-2 mt-24">
    <!-- Direct Generation Panel -->
    <div class="card" id="direct-panel">
        <h2 class="card-title">Generate Barrier Certificate</h2>
        <form id="query-form">
            <div class="form-field">
                <label for="system-description" class="form-label">
                    System Description *
                </label>
                <textarea 
                    id="system-description" 
                    name="system_description" 
                    class="form-textarea" 
                    placeholder="Enter your system description here...

Example:
System Dynamics: dx/dt = -x**3 - y, dy/dt = x - y**3
Initial Set: x**2 + y**2 <= 0.1
Unsafe Set: x >= 1.5

Note: Also specify Domain Bounds below (e.g., x ∈ [-2,2], y ∈ [-2,2])" 
                    required
                ></textarea>
                <small style="color: var(--md-sys-color-on-surface-variant); margin-top: 8px; display: block;">
                    Describe your autonomous system including dynamics, initial set, unsafe set, and state variables.
                </small>
            </div>
            
            <div class="form-field">
                <label for="model-config" class="form-label">Model Configuration</label>
                <select id="model-config" name="model_config" class="form-select">
                    {% for model in model_configs %}
                    <option value="{{ model.key }}" 
                        {% if loop.first %}selected{% endif %}
                        data-type="{{ model.type }}"
                        data-barrier-type="{{ model.barrier_type }}">
                        {{ model.name }} - {{ model.description }}
                    </option>
                    {% endfor %}
                </select>
                <small style="color: var(--md-sys-color-on-surface-variant); margin-top: 8px; display: block;">
                    Choose between base model or fine-tuned variants for barrier certificate generation.
                </small>
            </div>
            
            <div class="form-field">
                <label for="rag-k" class="form-label">
                    RAG Context Chunks (k)
                </label>
                <select id="rag-k" name="rag_k" class="form-select">
                    <option value="0">Disabled (0)</option>
                    <option value="1">1 chunk</option>
                    <option value="2">2 chunks</option>
                    <option value="3" selected>3 chunks</option>
                    <option value="5">5 chunks</option>
                    <option value="10">10 chunks</option>
                </select>
                <small style="color: var(--md-sys-color-on-surface-variant); margin-top: 8px; display: block;">
                    Number of relevant research paper chunks to retrieve for context (RAG). Higher values provide more context but may slow generation.
                </small>
            </div>
            
            <!-- Domain Bounds Settings -->
            <details open style="margin-top: 16px;">
                <summary style="cursor: pointer; font-weight: 600; margin-bottom: 8px;">Domain Bounds (Certificate Validity Region) *</summary>
                <div style="margin-top: 12px;">
                    <p style="color: var(--md-sys-color-on-surface-variant); font-size: 14px; margin-bottom: 12px;">
                        Specify the domain where the barrier certificate should be valid. <strong>Required for optimal results.</strong> Define reasonable bounds for all state variables.
                    </p>
                    <div id="domain-bounds-container">
                        <div class="domain-bound-row" style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                            <input type="text" class="form-input domain-var" placeholder="Variable (e.g., x)" value="x" style="width: 80px;">
                            <span>∈ [</span>
                            <input type="number" class="form-input domain-min" placeholder="Min" value="-3" style="width: 80px;" step="0.1">
                            <span>,</span>
                            <input type="number" class="form-input domain-max" placeholder="Max" value="3" style="width: 80px;" step="0.1">
                            <span>]</span>
                            <button type="button" class="btn btn-outline" onclick="removeDomainBound(this)" style="font-size: 12px; padding: 4px 8px;">Remove</button>
                        </div>
                        <div class="domain-bound-row" style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                            <input type="text" class="form-input domain-var" placeholder="Variable (e.g., y)" value="y" style="width: 80px;">
                            <span>∈ [</span>
                            <input type="number" class="form-input domain-min" placeholder="Min" value="-3" style="width: 80px;" step="0.1">
                            <span>,</span>
                            <input type="number" class="form-input domain-max" placeholder="Max" value="3" style="width: 80px;" step="0.1">
                            <span>]</span>
                            <button type="button" class="btn btn-outline" onclick="removeDomainBound(this)" style="font-size: 12px; padding: 4px 8px;">Remove</button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-outline" onclick="addDomainBound()" style="font-size: 14px; margin-top: 8px;">
                        <span class="material-icons" style="font-size: 16px;">add</span>
                        Add Domain Bound
                    </button>
                </div>
            </details>
            
            <!-- Verification Settings (collapsible) -->
            <details style="margin-top: 16px;">
                <summary style="cursor: pointer; font-weight: 600; margin-bottom: 8px;">Advanced Verification Settings</summary>
                <div style="margin-top: 12px;">
                    <div class="form-field">
                        <label class="form-label" for="num_samples_lie">Samples for ΔB ≤ 0 (safe set)</label>
                        <input type="number" id="num_samples_lie" name="num_samples_lie" class="form-input" value="9100" min="100" step="1000">
                    </div>
                    <div class="form-field">
                        <label class="form-label" for="num_samples_boundary">Samples for boundary checks</label>
                        <input type="number" id="num_samples_boundary" name="num_samples_boundary" class="form-input" value="4600" min="100" step="500">
                    </div>
                    <div class="form-field">
                        <label class="form-label" for="numerical_tolerance">Numerical Tolerance</label>
                        <input type="number" id="numerical_tolerance" name="numerical_tolerance" class="form-input" value="1e-6" step="1e-7">
                    </div>

                    <div class="form-field" style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="attempt_sos" name="attempt_sos" checked>
                        <label for="attempt_sos">Attempt SOS Verification (polynomial systems only)</label>
                    </div>

                    <div class="form-field" style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="attempt_optimization" name="attempt_optimization">
                        <label for="attempt_optimization">Run Optimisation-Based Falsification</label>
                    </div>

                    <!-- Optimisation parameters (shown only when checkbox checked) -->
                    <div id="opt-params" style="margin-left: 16px; display: none;">
                        <div class="form-field">
                            <label class="form-label" for="optimization_max_iter">Optimisation Max Iterations</label>
                            <input type="number" id="optimization_max_iter" name="optimization_max_iter" class="form-input" value="100" min="10" step="10">
                        </div>
                        <div class="form-field">
                            <label class="form-label" for="optimization_pop_size">Optimisation Population Size</label>
                            <input type="number" id="optimization_pop_size" name="optimization_pop_size" class="form-input" value="15" min="5" step="5">
                        </div>
                    </div>
                </div>
            </details>
            
            <button type="submit" class="btn btn-primary" id="submit-btn">
                <span class="material-icons">psychology</span>
                Generate Certificate
            </button>
        </form>
    </div>
    
    <!-- Conversation Panel -->
    <div class="card hidden" id="conversation-panel">
        <h2 class="card-title">Conversation with AI</h2>
        
        <!-- Conversation Setup -->
        <div id="conversation-setup">
            <div class="form-field">
                <label for="conv-model-config" class="form-label">Model Configuration</label>
                <select id="conv-model-config" name="model_config" class="form-select">
                    {% for model in model_configs %}
                    <option value="{{ model.key }}" 
                        {% if loop.first %}selected{% endif %}
                        data-type="{{ model.type }}"
                        data-barrier-type="{{ model.barrier_type }}">
                        {{ model.name }} - {{ model.description }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-field">
                <label for="conv-rag-k" class="form-label">RAG Context Chunks</label>
                <select id="conv-rag-k" name="rag_k" class="form-select">
                    <option value="0">Disabled (0)</option>
                    <option value="1">1 chunk</option>
                    <option value="2">2 chunks</option>
                    <option value="3" selected>3 chunks</option>
                    <option value="5">5 chunks</option>
                    <option value="10">10 chunks</option>
                </select>
            </div>
            
            <button id="start-conversation-btn" class="btn btn-primary">
                <span class="material-icons">chat</span>
                Start Conversation
            </button>
        </div>
        
        <!-- Active Conversation -->
        <div id="conversation-active" class="hidden">
            <!-- Ready to Generate Toggle -->
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding: 12px; background-color: var(--md-sys-color-primary-container); border-radius: 8px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="ready-to-generate" style="transform: scale(1.2);">
                    <span style="font-weight: 600;">Ready to Generate Certificate</span>
                </label>
                <button id="generate-from-conversation-btn" class="btn btn-primary" disabled>
                    <span class="material-icons">psychology</span>
                    Generate
                </button>
            </div>
            
            <!-- Chat Interface -->
            <div id="chat-container" style="height: 400px; overflow-y: auto; border: 1px solid var(--md-sys-color-outline); border-radius: 8px; padding: 16px; margin-bottom: 16px; background-color: var(--md-sys-color-surface-variant);">
                <div id="chat-messages">
                    <!-- Messages will be populated here -->
                </div>
            </div>
            
            <!-- Message Input -->
            <div style="display: flex; gap: 8px;">
                <input type="text" id="message-input" class="form-input" style="flex: 1;" placeholder="Type your message here..." autocomplete="off">
                <button id="send-message-btn" class="btn btn-primary">
                    <span class="material-icons">send</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Results Panel -->
    <div class="card">
        <h2 class="card-title">Results</h2>
        <div id="results-content">
            <div id="initial-state" class="text-center" style="color: var(--md-sys-color-on-surface-variant); padding: 48px 0;">
                <span class="material-icons" style="font-size: 48px; margin-bottom: 16px; display: block;">functions</span>
                <p>Enter a system description and click "Generate Certificate" to begin.</p>
            </div>
            
            <!-- Processing State -->
            <div id="processing-state" class="hidden">
                <div class="text-center mb-24">
                    <span class="material-icons" style="font-size: 48px; margin-bottom: 16px; display: block; animation: spin 1s linear infinite;">sync</span>
                    <h3 id="processing-status">Processing your request...</h3>
                    <p id="processing-detail" style="color: var(--md-sys-color-on-surface-variant);">Initializing...</p>
                </div>
                <div class="progress">
                    <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Results State -->
            <div id="results-state" class="hidden">
                <div id="generation-results">
                    <h3>Generated Certificate</h3>
                    <div id="certificate-display" class="card" style="background-color: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container); font-family: monospace; margin: 16px 0;">
                        <!-- Certificate will be populated here -->
                    </div>
                    
                    <h3>Verification Results</h3>
                    <div id="verification-results">
                        <!-- Verification results will be populated here -->
                    </div>
                    
                    <!-- Conversation-specific certificate decision -->
                    <div id="certificate-decision" class="hidden mt-16">
                        <h3>Certificate Decision</h3>
                        <p style="color: var(--md-sys-color-on-surface-variant); margin-bottom: 12px;">
                            What would you like to do with this generated certificate?
                        </p>
                        <div style="display: flex; gap: 12px;">
                            <button id="accept-certificate-btn" class="btn btn-primary">
                                <span class="material-icons">check_circle</span>
                                Accept Certificate
                            </button>
                            <button id="reject-certificate-btn" class="btn btn-outline">
                                <span class="material-icons">cancel</span>
                                Reject & Continue Discussion
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-16">
                        <a href="#" id="view-details-link" class="btn btn-outline">
                            <span class="material-icons">visibility</span>
                            View Full Details
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Error State -->
            <div id="error-state" class="hidden">
                <div class="text-center">
                    <span class="material-icons" style="font-size: 48px; margin-bottom: 16px; display: block; color: var(--md-sys-color-error);">error</span>
                    <h3 style="color: var(--md-sys-color-error);">Generation Failed</h3>
                    <p id="error-message" style="color: var(--md-sys-color-on-surface-variant);">
                        <!-- Error message will be populated here -->
                    </p>
                    <button class="btn btn-outline mt-16" onclick="resetForm()">
                        <span class="material-icons">refresh</span>
                        Try Again
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Queries -->
{% if recent_queries %}
<div class="card mt-24">
    <h2 class="card-title">Recent Queries</h2>
    <div class="grid grid-3">
        {% for query in recent_queries %}
        <div class="card" style="margin: 8px 0;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                <span class="status-chip status-{{ 'success' if query.status == 'completed' else 'error' if query.status == 'failed' else 'processing' if query.status == 'processing' else 'pending' }}">
                    {{ query.status.title() }}
                </span>
                <small style="color: var(--md-sys-color-on-surface-variant);">
                    {{ query.timestamp.strftime('%m/%d %H:%M') }}
                </small>
            </div>
            <p style="font-size: 14px; margin: 8px 0; color: var(--md-sys-color-on-surface-variant); line-height: 1.4;">
                {{ query.system_description[:100] }}{% if query.system_description|length > 100 %}...{% endif %}
            </p>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                <small style="color: var(--md-sys-color-on-surface-variant);">
                    {{ query.model_config }} | k={{ query.rag_k }}
                </small>
                <a href="{{ url_for('view_query', query_id=query.id) }}" class="btn btn-outline" style="font-size: 12px; padding: 4px 12px; min-height: 32px;">
                    View
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <div class="text-center mt-16">
        <a href="{{ url_for('query_history') }}" class="btn btn-secondary">
            <span class="material-icons">history</span>
            View All History
        </a>
    </div>
</div>
{% endif %}

<style>
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.verification-check {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 0;
    border-bottom: 1px solid var(--md-sys-color-outline-variant);
}

.verification-check:last-child {
    border-bottom: none;
}

.verification-icon {
    font-size: 20px;
}

.verification-icon.passed {
    color: var(--md-sys-color-success);
}

.verification-icon.failed {
    color: var(--md-sys-color-error);
}
</style>
{% endblock %}

{% block extra_scripts %}
<script>
let currentTaskId = null;
let pollInterval = null;
let currentSessionId = null;
let currentQueryId = null;
let currentGenerationMode = 'direct';

document.getElementById('query-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    
    // Parse numeric overrides explicitly (FormData returns strings)
    if (data.num_samples_lie) data.num_samples_lie = parseInt(data.num_samples_lie);
    if (data.num_samples_boundary) data.num_samples_boundary = parseInt(data.num_samples_boundary);
    if (data.numerical_tolerance) data.numerical_tolerance = parseFloat(data.numerical_tolerance);
    if (data.optimization_max_iter) data.optimization_max_iter = parseInt(data.optimization_max_iter);
    if (data.optimization_pop_size) data.optimization_pop_size = parseInt(data.optimization_pop_size);

    // Ensure checkboxes are transmitted as booleans
    data.attempt_sos = document.getElementById('attempt_sos').checked;
    data.attempt_optimization = document.getElementById('attempt_optimization').checked;
    
    // Collect domain bounds
    data.domain_bounds = getDomainBounds();
    
    // Validate input
    if (!data.system_description.trim()) {
        showStatus('Please enter a system description', 'error');
        return;
    }
    
    // Show processing state
    showProcessingState();
    
    try {
        const response = await fetch('/query', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            currentTaskId = result.task_id;
            startPolling();
        } else {
            showErrorState(result.error || 'Failed to submit query');
        }
    } catch (error) {
        showErrorState('Network error: ' + error.message);
    }
});

function showProcessingState() {
    document.getElementById('initial-state').classList.add('hidden');
    document.getElementById('results-state').classList.add('hidden');
    document.getElementById('error-state').classList.add('hidden');
    document.getElementById('processing-state').classList.remove('hidden');
    
    // Disable form
    document.getElementById('submit-btn').disabled = true;
    document.getElementById('submit-btn').innerHTML = '<span class="material-icons">hourglass_empty</span> Processing...';
}

function showResultsState(query) {
    document.getElementById('processing-state').classList.add('hidden');
    document.getElementById('error-state').classList.add('hidden');
    document.getElementById('results-state').classList.remove('hidden');
    
    // Show certificate
    const certificateDiv = document.getElementById('certificate-display');
    if (query.generated_certificate) {
        certificateDiv.innerHTML = `B(x, y) = ${query.generated_certificate}`;
    } else {
        certificateDiv.innerHTML = '<em>No certificate could be extracted from the model output</em>';
        certificateDiv.style.backgroundColor = 'var(--md-sys-color-error-container)';
        certificateDiv.style.color = 'var(--md-sys-color-on-error-container)';
    }
    
    // Show verification results
    const verificationDiv = document.getElementById('verification-results');
    if (query.verification_summary) {
        const verification = query.verification_summary;
        verificationDiv.innerHTML = `
            <div class="verification-check">
                <span class="material-icons verification-icon ${verification.numerical ? 'passed' : 'failed'}">
                    ${verification.numerical ? 'check_circle' : 'cancel'}
                </span>
                <span>Numerical Verification: ${verification.numerical ? 'Passed' : 'Failed'}</span>
            </div>
            <div class="verification-check">
                <span class="material-icons verification-icon ${verification.symbolic ? 'passed' : 'failed'}">
                    ${verification.symbolic ? 'check_circle' : 'cancel'}
                </span>
                <span>Symbolic Verification: ${verification.symbolic ? 'Passed' : 'Failed'}</span>
            </div>
            <div class="verification-check">
                <span class="material-icons verification-icon ${verification.sos ? 'passed' : 'failed'}">
                    ${verification.sos ? 'check_circle' : 'cancel'}
                </span>
                <span>SOS Verification: ${verification.sos ? 'Passed' : 'Failed'}</span>
            </div>
            <div class="verification-check">
                <span class="material-icons verification-icon ${verification.overall ? 'passed' : 'failed'}">
                    ${verification.overall ? 'verified' : 'dangerous'}
                </span>
                <strong>Overall: ${verification.overall ? 'Certificate Verified' : 'Verification Failed'}</strong>
            </div>
        `;
    } else {
        verificationDiv.innerHTML = '<em>Verification results not available</em>';
    }
    
    // Show/hide certificate decision based on generation mode
    if (currentGenerationMode === 'conversation' && currentSessionId) {
        document.getElementById('certificate-decision').classList.remove('hidden');
    } else {
        document.getElementById('certificate-decision').classList.add('hidden');
    }
    
    // Set details link
    document.getElementById('view-details-link').href = `/query/${query.id}`;
    
    // Re-enable form (for direct mode)
    if (currentGenerationMode === 'direct') {
        resetForm();
    }
}

function showErrorState(error) {
    document.getElementById('processing-state').classList.add('hidden');
    document.getElementById('results-state').classList.add('hidden');
    document.getElementById('error-state').classList.remove('hidden');
    
    document.getElementById('error-message').textContent = error;
    
    // Re-enable form
    resetForm();
}

function resetForm() {
    document.getElementById('submit-btn').disabled = false;
    document.getElementById('submit-btn').innerHTML = '<span class="material-icons">psychology</span> Generate Certificate';
    
    if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
    }
    currentTaskId = null;
}

function showStatus(message, type) {
    // Simple status display - could be enhanced with a proper notification system
    const statusColor = type === 'success' ? 'var(--md-sys-color-primary)' : 'var(--md-sys-color-error)';
    console.log(`[${type.toUpperCase()}] ${message}`);
    
    // Could add a toast notification here
    if (type === 'error') {
        alert('Error: ' + message);
    }
}

function startPolling() {
    pollInterval = setInterval(async () => {
        if (!currentTaskId) return;
        
        try {
            const response = await fetch(`/task_status/${currentTaskId}`);
            const status = await response.json();
            
            // Handle task not found (cleaned up)
            if (status.status === 'not_found') {
                clearInterval(pollInterval);
                showErrorState('Task expired or was cleaned up. Please try again.');
                showStatus('Task not found. Please submit a new query.', 'error');
                return;
            }
            
            // Update progress
            document.getElementById('progress-bar').style.width = `${status.progress}%`;
            
            // Update status text
            const statusText = document.getElementById('processing-status');
            const detailText = document.getElementById('processing-detail');
            
            switch (status.status) {
                case 'processing':
                    statusText.textContent = 'Generating barrier certificate...';
                    detailText.textContent = 'Using LLM to generate certificate based on system description';
                    break;
                case 'generating':
                    statusText.textContent = 'Generating barrier certificate...';
                    detailText.textContent = 'Using LLM to generate certificate based on system description';
                    break;
                case 'verifying':
                    statusText.textContent = 'Verifying certificate...';
                    detailText.textContent = 'Running numerical, symbolic, and SOS verification checks';
                    break;
                case 'completed':
                    clearInterval(pollInterval);
                    showResultsState(status.query);
                    showStatus('Certificate generation completed!', 'success');
                    break;
                case 'failed':
                    clearInterval(pollInterval);
                    showErrorState(status.error || 'Task failed');
                    showStatus('Certificate generation failed', 'error');
                    break;
            }
        } catch (error) {
            console.error('Polling error:', error);
            // If we get repeated errors, stop polling
            if (error.message.includes('404') || error.message.includes('not found')) {
                clearInterval(pollInterval);
                showErrorState('Connection lost or task expired. Please try again.');
                showStatus('Lost connection to task. Please submit a new query.', 'error');
            }
        }
    }, 1000); // Poll every second
}

// ============ CONVERSATION FUNCTIONS ============

function switchMode(mode) {
    currentGenerationMode = mode;
    if (mode === 'direct') {
        document.getElementById('direct-panel').classList.remove('hidden');
        document.getElementById('conversation-panel').classList.add('hidden');
        document.getElementById('certificate-decision').classList.add('hidden');
    } else {
        document.getElementById('direct-panel').classList.add('hidden');
        document.getElementById('conversation-panel').classList.remove('hidden');
    }
}

async function startConversation() {
    try {
        const modelConfig = document.getElementById('conv-model-config').value;
        const ragK = parseInt(document.getElementById('conv-rag-k').value);
        
        const response = await fetch('/conversation/start', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                model_config: modelConfig,
                rag_k: ragK
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            currentSessionId = result.session_id;
            
            // Hide setup, show active conversation
            document.getElementById('conversation-setup').classList.add('hidden');
            document.getElementById('conversation-active').classList.remove('hidden');
            
            // Add initial message
            addMessageToChat(result.initial_message);
            
            showStatus('Conversation started successfully!', 'success');
        } else {
            showStatus('Failed to start conversation: ' + result.error, 'error');
        }
    } catch (error) {
        showStatus('Error starting conversation: ' + error.message, 'error');
    }
}

async function sendMessage() {
    const messageInput = document.getElementById('message-input');
    const message = messageInput.value.trim();
    
    if (!message || !currentSessionId) return;
    
    messageInput.value = '';
    document.getElementById('send-message-btn').disabled = true;
    
    // Add user message to chat
    addMessageToChat({
        role: 'user',
        content: message,
        timestamp: new Date().toISOString()
    });
    
    try {
        const response = await fetch(`/conversation/${currentSessionId}/message`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: message,
                message_type: 'chat'
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Add assistant response
            addMessageToChat(result.assistant_message);
        } else {
            showStatus('Failed to send message: ' + result.error, 'error');
        }
    } catch (error) {
        showStatus('Error sending message: ' + error.message, 'error');
    } finally {
        document.getElementById('send-message-btn').disabled = false;
    }
}

function addMessageToChat(message) {
    const chatMessages = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message message-${message.role}`;
    
    const timestamp = new Date(message.timestamp).toLocaleTimeString();
    
    messageDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px;">
            <strong style="color: ${message.role === 'user' ? 'var(--md-sys-color-primary)' : 'var(--md-sys-color-secondary)'};">
                ${message.role === 'user' ? 'You' : 'AI Assistant'}
            </strong>
            <small style="color: var(--md-sys-color-on-surface-variant);">${timestamp}</small>
        </div>
        <div style="white-space: pre-wrap; line-height: 1.4;">${message.content}</div>
    `;
    
    messageDiv.style.marginBottom = '16px';
    messageDiv.style.padding = '12px';
    messageDiv.style.borderRadius = '8px';
    messageDiv.style.backgroundColor = message.role === 'user' 
        ? 'var(--md-sys-color-primary-container)' 
        : 'var(--md-sys-color-secondary-container)';
    
    chatMessages.appendChild(messageDiv);
    
    // Scroll to bottom
    const chatContainer = document.getElementById('chat-container');
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

async function setReadyToGenerate(ready) {
    if (!currentSessionId) return;
    
    try {
        const response = await fetch(`/conversation/${currentSessionId}/ready`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ ready: ready })
        });
        
        const result = await response.json();
        
        if (result.success) {
            document.getElementById('generate-from-conversation-btn').disabled = !ready;
        } else {
            showStatus('Failed to update ready status: ' + result.error, 'error');
        }
    } catch (error) {
        showStatus('Error updating ready status: ' + error.message, 'error');
    }
}

async function generateFromConversation() {
    if (!currentSessionId) return;
    
    try {
        // Show processing state
        showProcessingState();
        
        const response = await fetch(`/conversation/${currentSessionId}/generate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                // Could include verification parameters here
                attempt_sos: true,
                attempt_optimization: false
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            currentTaskId = result.task_id;
            currentQueryId = result.query_id;
            startPolling();
        } else {
            showErrorState(result.error || 'Failed to generate certificate from conversation');
        }
    } catch (error) {
        showErrorState('Error generating certificate: ' + error.message);
    }
}

async function acceptCertificate() {
    if (!currentSessionId || !currentQueryId) return;
    
    try {
        const response = await fetch(`/conversation/${currentSessionId}/accept_certificate/${currentQueryId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showStatus('Certificate accepted successfully!', 'success');
            document.getElementById('certificate-decision').classList.add('hidden');
        } else {
            showStatus('Failed to accept certificate: ' + result.error, 'error');
        }
    } catch (error) {
        showStatus('Error accepting certificate: ' + error.message, 'error');
    }
}

async function rejectCertificate() {
    if (!currentSessionId || !currentQueryId) return;
    
    try {
        const response = await fetch(`/conversation/${currentSessionId}/reject_certificate/${currentQueryId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showStatus('Certificate rejected. You can continue the conversation.', 'success');
            document.getElementById('certificate-decision').classList.add('hidden');
            document.getElementById('ready-to-generate').checked = false;
            document.getElementById('generate-from-conversation-btn').disabled = true;
            
            // Clear results and return to conversation
            document.getElementById('results-state').classList.add('hidden');
            document.getElementById('initial-state').classList.remove('hidden');
        } else {
            showStatus('Failed to reject certificate: ' + result.error, 'error');
        }
    } catch (error) {
        showStatus('Error rejecting certificate: ' + error.message, 'error');
    }
}

// ============ END CONVERSATION FUNCTIONS ============

// Auto-clear initial state
document.addEventListener('DOMContentLoaded', function() {
    // Set active nav link
    const currentPath = window.location.pathname;
    document.querySelectorAll('.nav-link').forEach(link => {
        if (link.getAttribute('href') === currentPath) {
            link.classList.add('active');
        }
    });
    
    // Mode selection event listeners
    document.querySelectorAll('input[name="generation-mode"]').forEach(radio => {
        radio.addEventListener('change', function() {
            switchMode(this.value);
        });
    });
    
    // Conversation event listeners
    document.getElementById('start-conversation-btn').addEventListener('click', startConversation);
    document.getElementById('send-message-btn').addEventListener('click', sendMessage);
    document.getElementById('message-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            sendMessage();
        }
    });
    
    // Ready to generate checkbox
    document.getElementById('ready-to-generate').addEventListener('change', function() {
        setReadyToGenerate(this.checked);
    });
    
    // Generation from conversation
    document.getElementById('generate-from-conversation-btn').addEventListener('click', generateFromConversation);
    
    // Certificate decision buttons
    document.getElementById('accept-certificate-btn').addEventListener('click', acceptCertificate);
    document.getElementById('reject-certificate-btn').addEventListener('click', rejectCertificate);
});

// Show/hide optimisation parameters
document.getElementById('attempt_optimization').addEventListener('change', function(e) {
    document.getElementById('opt-params').style.display = e.target.checked ? 'block' : 'none';
});

// Domain bounds functions
function addDomainBound() {
    const container = document.getElementById('domain-bounds-container');
    const row = document.createElement('div');
    row.className = 'domain-bound-row';
    row.style.cssText = 'display: flex; gap: 8px; align-items: center; margin-bottom: 8px;';
    row.innerHTML = `
        <input type="text" class="form-input domain-var" placeholder="Variable (e.g., x)" style="width: 80px;">
        <span>∈ [</span>
        <input type="number" class="form-input domain-min" placeholder="Min" style="width: 80px;" step="0.1">
        <span>,</span>
        <input type="number" class="form-input domain-max" placeholder="Max" style="width: 80px;" step="0.1">
        <span>]</span>
        <button type="button" class="btn btn-outline" onclick="removeDomainBound(this)" style="font-size: 12px; padding: 4px 8px;">Remove</button>
    `;
    container.appendChild(row);
}

function removeDomainBound(button) {
    const container = document.getElementById('domain-bounds-container');
    if (container.children.length > 1) {
        button.parentElement.remove();
    }
}

function getDomainBounds() {
    const bounds = {};
    const rows = document.querySelectorAll('.domain-bound-row');
    
    rows.forEach(row => {
        const varInput = row.querySelector('.domain-var');
        const minInput = row.querySelector('.domain-min');
        const maxInput = row.querySelector('.domain-max');
        
        const variable = varInput.value.trim();
        const min = parseFloat(minInput.value);
        const max = parseFloat(maxInput.value);
        
        if (variable && !isNaN(min) && !isNaN(max)) {
            bounds[variable] = [min, max];
        }
    });
    
    return Object.keys(bounds).length > 0 ? bounds : null;
}

function setDomainBounds(bounds) {
    const container = document.getElementById('domain-bounds-container');
    container.innerHTML = '';
    
    if (!bounds || Object.keys(bounds).length === 0) {
        addDomainBound();
        return;
    }
    
    Object.entries(bounds).forEach(([variable, [min, max]]) => {
        const row = document.createElement('div');
        row.className = 'domain-bound-row';
        row.style.cssText = 'display: flex; gap: 8px; align-items: center; margin-bottom: 8px;';
        row.innerHTML = `
            <input type="text" class="form-input domain-var" placeholder="Variable (e.g., x)" style="width: 80px;" value="${variable}">
            <span>∈ [</span>
            <input type="number" class="form-input domain-min" placeholder="Min" style="width: 80px;" step="0.1" value="${min}">
            <span>,</span>
            <input type="number" class="form-input domain-max" placeholder="Max" style="width: 80px;" step="0.1" value="${max}">
            <span>]</span>
            <button type="button" class="btn btn-outline" onclick="removeDomainBound(this)" style="font-size: 12px; padding: 4px 8px;">Remove</button>
        `;
        container.appendChild(row);
    });
}
</script>
{% endblock %} 