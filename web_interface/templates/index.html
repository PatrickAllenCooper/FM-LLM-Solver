{% extends "base.html" %}

{% block title %}FM-LLM Solver - Barrier Certificate Generation{% endblock %}

{% block content %}
<!-- Mode Selection -->
<div class="card mt-24">
    <h2 class="card-title">Choose Generation Mode</h2>
    <div style="display: flex; gap: 16px; margin-bottom: 16px;">
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="radio" name="generation-mode" value="direct" checked>
            <span>Direct Generation</span>
        </label>
        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
            <input type="radio" name="generation-mode" value="conversation">
            <span>Conversational Mode</span>
        </label>
    </div>
    <p style="color: var(--md-sys-color-on-surface-variant); font-size: 14px;">
        <strong>Direct:</strong> Provide complete system description and generate immediately<br>
        <strong>Conversational:</strong> Discuss your system with the AI, refine the description, then generate
    </p>
</div>

<div class="grid grid-2 mt-24">
    <!-- Direct Generation Panel -->
    <div class="card" id="direct-panel">
        <h2 class="card-title">Generate Barrier Certificate</h2>
        <form id="query-form">
            <div class="form-field">
                <label for="system-description" class="form-label">
                    System Description *
                </label>
                <textarea 
                    id="system-description" 
                    name="system_description" 
                    class="form-textarea" 
                    placeholder="Enter your system description here...

Example:
System Dynamics: dx/dt = -x**3 - y, dy/dt = x - y**3
Initial Set: x**2 + y**2 <= 0.1
Unsafe Set: x >= 1.5

Note: Also specify Domain Bounds below (e.g., x ∈ [-2,2], y ∈ [-2,2])" 
                    required
                ></textarea>
                <small style="color: var(--md-sys-color-on-surface-variant); margin-top: 8px; display: block;">
                    Describe your autonomous system including dynamics, initial set, unsafe set, and state variables.
                </small>
            </div>
            
            <div class="form-field">
                <label for="model-config" class="form-label">Model Configuration</label>
                <select id="model-config" name="model_config" class="form-select">
                    {% for model in model_configs %}
                    <option value="{{ model.key }}" 
                        {% if loop.first %}selected{% endif %}
                        data-type="{{ model.type }}"
                        data-barrier-type="{{ model.barrier_type }}">
                        {{ model.name }} - {{ model.description }}
                    </option>
                    {% endfor %}
                </select>
                <small style="color: var(--md-sys-color-on-surface-variant); margin-top: 8px; display: block;">
                    Choose between base model or fine-tuned variants for barrier certificate generation.
                </small>
            </div>
            
            <div class="form-field">
                <label for="rag-k" class="form-label">
                    RAG Context Chunks (k)
                </label>
                <select id="rag-k" name="rag_k" class="form-select">
                    <option value="0">Disabled (0)</option>
                    <option value="1">1 chunk</option>
                    <option value="2">2 chunks</option>
                    <option value="3" selected>3 chunks</option>
                    <option value="5">5 chunks</option>
                    <option value="10">10 chunks</option>
                </select>
                <small style="color: var(--md-sys-color-on-surface-variant); margin-top: 8px; display: block;">
                    Number of relevant research paper chunks to retrieve for context (RAG). Higher values provide more context but may slow generation.
                </small>
            </div>
            
            <!-- Domain Bounds Settings -->
            <details open style="margin-top: 16px;">
                <summary style="cursor: pointer; font-weight: 600; margin-bottom: 8px;">Domain Bounds (Certificate Validity Region) *</summary>
                <div style="margin-top: 12px;">
                    <p style="color: var(--md-sys-color-on-surface-variant); font-size: 14px; margin-bottom: 12px;">
                        Specify the domain where the barrier certificate should be valid. <strong>Required for optimal results.</strong> Define reasonable bounds for all state variables.
                    </p>
                    <div id="domain-bounds-container">
                        <div class="domain-bound-row" style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                            <input type="text" class="form-input domain-var" placeholder="Variable (e.g., x)" value="x" style="width: 80px;">
                            <span>∈ [</span>
                            <input type="number" class="form-input domain-min" placeholder="Min" value="-3" style="width: 80px;" step="0.1">
                            <span>,</span>
                            <input type="number" class="form-input domain-max" placeholder="Max" value="3" style="width: 80px;" step="0.1">
                            <span>]</span>
                            <button type="button" class="btn btn-outline" onclick="removeDomainBound(this)" style="font-size: 12px; padding: 4px 8px;">Remove</button>
                        </div>
                        <div class="domain-bound-row" style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px;">
                            <input type="text" class="form-input domain-var" placeholder="Variable (e.g., y)" value="y" style="width: 80px;">
                            <span>∈ [</span>
                            <input type="number" class="form-input domain-min" placeholder="Min" value="-3" style="width: 80px;" step="0.1">
                            <span>,</span>
                            <input type="number" class="form-input domain-max" placeholder="Max" value="3" style="width: 80px;" step="0.1">
                            <span>]</span>
                            <button type="button" class="btn btn-outline" onclick="removeDomainBound(this)" style="font-size: 12px; padding: 4px 8px;">Remove</button>
                        </div>
                    </div>
                    <button type="button" class="btn btn-outline" onclick="addDomainBound()" style="font-size: 14px; margin-top: 8px;">
                        <span class="material-icons" style="font-size: 16px;">add</span>
                        Add Domain Bound
                    </button>
                </div>
            </details>
            
            <!-- Verification Settings (collapsible) -->
            <details style="margin-top: 16px;">
                <summary style="cursor: pointer; font-weight: 600; margin-bottom: 8px;">Advanced Verification Settings</summary>
                <div style="margin-top: 12px;">
                    <div class="form-field">
                        <label class="form-label" for="num_samples_lie">Samples for ΔB ≤ 0 (safe set)</label>
                        <input type="number" id="num_samples_lie" name="num_samples_lie" class="form-input" value="9100" min="100" step="1000">
                    </div>
                    <div class="form-field">
                        <label class="form-label" for="num_samples_boundary">Samples for boundary checks</label>
                        <input type="number" id="num_samples_boundary" name="num_samples_boundary" class="form-input" value="4600" min="100" step="500">
                    </div>
                    <div class="form-field">
                        <label class="form-label" for="numerical_tolerance">Numerical Tolerance</label>
                        <input type="number" id="numerical_tolerance" name="numerical_tolerance" class="form-input" value="1e-6" step="1e-7">
                    </div>

                    <div class="form-field" style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="attempt_sos" name="attempt_sos" checked>
                        <label for="attempt_sos">Attempt SOS Verification (polynomial systems only)</label>
                    </div>

                    <div class="form-field" style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="attempt_optimization" name="attempt_optimization">
                        <label for="attempt_optimization">Run Optimisation-Based Falsification</label>
                    </div>

                    <!-- Optimisation parameters (shown only when checkbox checked) -->
                    <div id="opt-params" style="margin-left: 16px; display: none;">
                        <div class="form-field">
                            <label class="form-label" for="optimization_max_iter">Optimisation Max Iterations</label>
                            <input type="number" id="optimization_max_iter" name="optimization_max_iter" class="form-input" value="100" min="10" step="10">
                        </div>
                        <div class="form-field">
                            <label class="form-label" for="optimization_pop_size">Optimisation Population Size</label>
                            <input type="number" id="optimization_pop_size" name="optimization_pop_size" class="form-input" value="15" min="5" step="5">
                        </div>
                    </div>
                </div>
            </details>
            
            <button type="submit" class="btn btn-primary" id="submit-btn">
                <span class="material-icons">psychology</span>
                Generate Certificate
            </button>
        </form>
    </div>
    
    <!-- Conversation Panel -->
    <div class="card hidden" id="conversation-panel">
        <h2 class="card-title">Conversation with AI</h2>
        
        <!-- Conversation Setup -->
        <div id="conversation-setup">
            <div class="form-field">
                <label for="conv-model-config" class="form-label">Model Configuration</label>
                <select id="conv-model-config" name="model_config" class="form-select">
                    {% for model in model_configs %}
                    <option value="{{ model.key }}" 
                        {% if loop.first %}selected{% endif %}
                        data-type="{{ model.type }}"
                        data-barrier-type="{{ model.barrier_type }}">
                        {{ model.name }} - {{ model.description }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            
            <div class="form-field">
                <label for="conv-rag-k" class="form-label">RAG Context Chunks</label>
                <select id="conv-rag-k" name="rag_k" class="form-select">
                    <option value="0">Disabled (0)</option>
                    <option value="1">1 chunk</option>
                    <option value="2">2 chunks</option>
                    <option value="3" selected>3 chunks</option>
                    <option value="5">5 chunks</option>
                    <option value="10">10 chunks</option>
                </select>
            </div>
            
            <!-- Enhanced RAG Dataset Selection -->
            <div class="form-field" id="rag-dataset-config" style="display: none;">
                <label class="form-label">
                    <span class="material-icons" style="vertical-align: middle;">tune</span>
                    RAG Dataset Configuration
                </label>
                
                <!-- Dataset Type Selection -->
                <div class="form-field-group">
                    <label for="rag-dataset-type" class="form-sublabel">Dataset Type</label>
                    <select id="rag-dataset-type" name="rag_dataset_type" class="form-select">
                        <option value="unified" selected>All Papers (Unified)</option>
                        <option value="discrete">Discrete-Time Systems Only</option>
                        <option value="continuous">Continuous-Time Systems Only</option>
                        <option value="custom">Custom Selection</option>
                    </select>
                </div>
                
                <!-- Researcher Selection -->
                <div class="form-field-group" id="researcher-selection" style="display: none;">
                    <label class="form-sublabel">
                        <span class="material-icons" style="font-size: 16px;">people</span>
                        Select Researchers
                    </label>
                    <div class="researcher-grid" id="researcher-grid">
                        <!-- Researchers will be populated dynamically -->
                    </div>
                    <div class="researcher-summary">
                        <span id="selected-researchers-count">0</span> researchers selected
                        <button type="button" class="btn-link" onclick="selectAllResearchers()">Select All</button>
                        <button type="button" class="btn-link" onclick="clearAllResearchers()">Clear All</button>
                    </div>
                </div>
                
                <!-- Topic Filtering -->
                <div class="form-field-group" id="topic-filtering" style="display: none;">
                    <label class="form-sublabel">
                        <span class="material-icons" style="font-size: 16px;">topic</span>
                        Research Topics
                    </label>
                    <div class="topic-tags">
                        <label class="checkbox-tag">
                            <input type="checkbox" name="topics" value="barrier_certificates">
                            <span>Barrier Certificates</span>
                        </label>
                        <label class="checkbox-tag">
                            <input type="checkbox" name="topics" value="control_theory">
                            <span>Control Theory</span>
                        </label>
                        <label class="checkbox-tag">
                            <input type="checkbox" name="topics" value="formal_methods">
                            <span>Formal Methods</span>
                        </label>
                        <label class="checkbox-tag">
                            <input type="checkbox" name="topics" value="cyber_physical">
                            <span>Cyber-Physical Systems</span>
                        </label>
                        <label class="checkbox-tag">
                            <input type="checkbox" name="topics" value="safety_verification">
                            <span>Safety Verification</span>
                        </label>
                        <label class="checkbox-tag">
                            <input type="checkbox" name="topics" value="hybrid_systems">
                            <span>Hybrid Systems</span>
                        </label>
                    </div>
                </div>
                
                <!-- Dataset Preview -->
                <div class="form-field-group">
                    <label class="form-sublabel">
                        <span class="material-icons" style="font-size: 16px;">preview</span>
                        Dataset Preview
                    </label>
                    <div class="dataset-preview" id="dataset-preview">
                        <div class="preview-stats">
                            <span id="paper-count">Loading...</span> papers, 
                            <span id="chunk-count">Loading...</span> chunks available
                        </div>
                        <div class="preview-quality">
                            Quality Score: <span id="quality-score">--</span>/100
                        </div>
                    </div>
                </div>
            </div>
            
            <button type="button" class="btn btn-text" onclick="toggleRagConfig()" id="rag-config-toggle">
                <span class="material-icons">expand_more</span>
                Advanced RAG Configuration
            </button>
            
            <button id="start-conversation-btn" class="btn btn-primary">
                <span class="material-icons">chat</span>
                Start Conversation
            </button>
        </div>
        
        <!-- Active Conversation -->
        <div id="conversation-active" class="hidden">
            <!-- Ready to Generate Toggle -->
            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 16px; padding: 12px; background-color: var(--md-sys-color-primary-container); border-radius: 8px;">
                <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                    <input type="checkbox" id="ready-to-generate" style="transform: scale(1.2);">
                    <span style="font-weight: 600;">Ready to Generate Certificate</span>
                </label>
                <button id="generate-from-conversation-btn" class="btn btn-primary" disabled>
                    <span class="material-icons">psychology</span>
                    Generate
                </button>
            </div>
            
            <!-- Chat Interface -->
            <div id="chat-container" style="height: 400px; overflow-y: auto; border: 1px solid var(--md-sys-color-outline); border-radius: 8px; padding: 16px; margin-bottom: 16px; background-color: var(--md-sys-color-surface-variant);">
                <div id="chat-messages">
                    <!-- Messages will be populated here -->
                </div>
            </div>
            
            <!-- Message Input -->
            <div style="display: flex; gap: 8px;">
                <input type="text" id="message-input" class="form-input" style="flex: 1;" placeholder="Type your message here..." autocomplete="off">
                <button id="send-message-btn" class="btn btn-primary">
                    <span class="material-icons">send</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Results Panel -->
    <div class="card">
        <h2 class="card-title">Results</h2>
        <div id="results-content">
            <div id="initial-state" class="text-center" style="color: var(--md-sys-color-on-surface-variant); padding: 48px 0;">
                <span class="material-icons" style="font-size: 48px; margin-bottom: 16px; display: block;">functions</span>
                <p>Enter a system description and click "Generate Certificate" to begin.</p>
            </div>
            
            <!-- Processing State -->
            <div id="processing-state" class="hidden">
                <div class="text-center mb-24">
                    <span class="material-icons" style="font-size: 48px; margin-bottom: 16px; display: block; animation: spin 1s linear infinite;">sync</span>
                    <h3 id="processing-status">Processing your request...</h3>
                    <p id="processing-detail" style="color: var(--md-sys-color-on-surface-variant);">Initializing...</p>
                </div>
                <div class="progress">
                    <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
                </div>
            </div>
            
            <!-- Results State -->
            <div id="results-state" class="hidden">
                <div id="generation-results">
                    <h3>Generated Certificate</h3>
                    <div id="certificate-display" class="card" style="background-color: var(--md-sys-color-primary-container); color: var(--md-sys-color-on-primary-container); font-family: monospace; margin: 16px 0;">
                        <!-- Certificate will be populated here -->
                    </div>
                    
                    <h3>Verification Results</h3>
                    <div id="verification-results">
                        <!-- Verification results will be populated here -->
                    </div>
                    
                    <!-- Conversation-specific certificate decision -->
                    <div id="certificate-decision" class="hidden mt-16">
                        <h3>Certificate Decision</h3>
                        <p style="color: var(--md-sys-color-on-surface-variant); margin-bottom: 12px;">
                            What would you like to do with this generated certificate?
                        </p>
                        <div style="display: flex; gap: 12px;">
                            <button id="accept-certificate-btn" class="btn btn-primary">
                                <span class="material-icons">check_circle</span>
                                Accept Certificate
                            </button>
                            <button id="reject-certificate-btn" class="btn btn-outline">
                                <span class="material-icons">cancel</span>
                                Reject & Continue Discussion
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-16">
                        <a href="#" id="view-details-link" class="btn btn-outline">
                            <span class="material-icons">visibility</span>
                            View Full Details
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Error State -->
            <div id="error-state" class="hidden">
                <div class="text-center">
                    <span class="material-icons" style="font-size: 48px; margin-bottom: 16px; display: block; color: var(--md-sys-color-error);">error</span>
                    <h3 style="color: var(--md-sys-color-error);">Generation Failed</h3>
                    <p id="error-message" style="color: var(--md-sys-color-on-surface-variant);">
                        <!-- Error message will be populated here -->
                    </p>
                    <button class="btn btn-outline mt-16" onclick="resetForm()">
                        <span class="material-icons">refresh</span>
                        Try Again
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Recent Queries -->
{% if recent_queries %}
<div class="card mt-24">
    <h2 class="card-title">Recent Queries</h2>
    <div class="grid grid-3">
        {% for query in recent_queries %}
        <div class="card" style="margin: 8px 0;">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px;">
                <span class="status-chip status-{{ 'success' if query.status == 'completed' else 'error' if query.status == 'failed' else 'processing' if query.status == 'processing' else 'pending' }}">
                    {{ query.status.title() }}
                </span>
                <small style="color: var(--md-sys-color-on-surface-variant);">
                    {{ query.timestamp.strftime('%m/%d %H:%M') }}
                </small>
            </div>
            <p style="font-size: 14px; margin: 8px 0; color: var(--md-sys-color-on-surface-variant); line-height: 1.4;">
                {{ query.system_description[:100] }}{% if query.system_description|length > 100 %}...{% endif %}
            </p>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 12px;">
                <small style="color: var(--md-sys-color-on-surface-variant);">
                    {{ query.model_config }} | k={{ query.rag_k }}
                </small>
                <a href="{{ url_for('view_query', query_id=query.id) }}" class="btn btn-outline" style="font-size: 12px; padding: 4px 12px; min-height: 32px;">
                    View
                </a>
            </div>
        </div>
        {% endfor %}
    </div>
    
    <div class="text-center mt-16">
        <a href="{{ url_for('query_history') }}" class="btn btn-secondary">
            <span class="material-icons">history</span>
            View All History
        </a>
    </div>
</div>
{% endif %}

<style>
@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.verification-check {
    display: flex;
    align-items: center;
    gap: 8px;
    padding: 8px 0;
    border-bottom: 1px solid var(--md-sys-color-outline-variant);
}

.verification-check:last-child {
    border-bottom: none;
}

.verification-icon {
    font-size: 20px;
}

.verification-icon.passed {
    color: var(--md-sys-color-success);
}

.verification-icon.failed {
    color: var(--md-sys-color-error);
}
</style>
{% endblock %}

{% block extra_scripts %}
<script>
let currentTaskId = null;
let pollInterval = null;
let currentSessionId = null;
let currentQueryId = null;
let currentGenerationMode = 'direct';

document.getElementById('query-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = Object.fromEntries(formData);
    
    // Parse numeric overrides explicitly (FormData returns strings)
    if (data.num_samples_lie) data.num_samples_lie = parseInt(data.num_samples_lie);
    if (data.num_samples_boundary) data.num_samples_boundary = parseInt(data.num_samples_boundary);
    if (data.numerical_tolerance) data.numerical_tolerance = parseFloat(data.numerical_tolerance);
    if (data.optimization_max_iter) data.optimization_max_iter = parseInt(data.optimization_max_iter);
    if (data.optimization_pop_size) data.optimization_pop_size = parseInt(data.optimization_pop_size);

    // Ensure checkboxes are transmitted as booleans
    data.attempt_sos = document.getElementById('attempt_sos').checked;
    data.attempt_optimization = document.getElementById('attempt_optimization').checked;
    
    // Collect domain bounds
    data.domain_bounds = getDomainBounds();
    
    // Validate input
    if (!data.system_description.trim()) {
        showStatus('Please enter a system description', 'error');
        return;
    }
    
    // Show processing state
    showProcessingState();
    
    try {
        const response = await fetch('/query', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            currentTaskId = result.task_id;
            startPolling();
        } else {
            showErrorState(result.error || 'Failed to submit query');
        }
    } catch (error) {
        showErrorState('Network error: ' + error.message);
    }
});

function showProcessingState() {
    document.getElementById('initial-state').classList.add('hidden');
    document.getElementById('results-state').classList.add('hidden');
    document.getElementById('error-state').classList.add('hidden');
    document.getElementById('processing-state').classList.remove('hidden');
    
    // Disable form
    document.getElementById('submit-btn').disabled = true;
    document.getElementById('submit-btn').innerHTML = '<span class="material-icons">hourglass_empty</span> Processing...';
}

function showResultsState(query) {
    document.getElementById('processing-state').classList.add('hidden');
    document.getElementById('error-state').classList.add('hidden');
    document.getElementById('results-state').classList.remove('hidden');
    
    // Show certificate
    const certificateDiv = document.getElementById('certificate-display');
    if (query.generated_certificate) {
        certificateDiv.innerHTML = `B(x, y) = ${query.generated_certificate}`;
    } else {
        certificateDiv.innerHTML = '<em>No certificate could be extracted from the model output</em>';
        certificateDiv.style.backgroundColor = 'var(--md-sys-color-error-container)';
        certificateDiv.style.color = 'var(--md-sys-color-on-error-container)';
    }
    
    // Show verification results
    const verificationDiv = document.getElementById('verification-results');
    if (query.verification_summary) {
        const verification = query.verification_summary;
        verificationDiv.innerHTML = `
            <div class="verification-check">
                <span class="material-icons verification-icon ${verification.numerical ? 'passed' : 'failed'}">
                    ${verification.numerical ? 'check_circle' : 'cancel'}
                </span>
                <span>Numerical Verification: ${verification.numerical ? 'Passed' : 'Failed'}</span>
            </div>
            <div class="verification-check">
                <span class="material-icons verification-icon ${verification.symbolic ? 'passed' : 'failed'}">
                    ${verification.symbolic ? 'check_circle' : 'cancel'}
                </span>
                <span>Symbolic Verification: ${verification.symbolic ? 'Passed' : 'Failed'}</span>
            </div>
            <div class="verification-check">
                <span class="material-icons verification-icon ${verification.sos ? 'passed' : 'failed'}">
                    ${verification.sos ? 'check_circle' : 'cancel'}
                </span>
                <span>SOS Verification: ${verification.sos ? 'Passed' : 'Failed'}</span>
            </div>
            <div class="verification-check">
                <span class="material-icons verification-icon ${verification.overall ? 'passed' : 'failed'}">
                    ${verification.overall ? 'verified' : 'dangerous'}
                </span>
                <strong>Overall: ${verification.overall ? 'Certificate Verified' : 'Verification Failed'}</strong>
            </div>
        `;
    } else {
        verificationDiv.innerHTML = '<em>Verification results not available</em>';
    }
    
    // Show/hide certificate decision based on generation mode
    if (currentGenerationMode === 'conversation' && currentSessionId) {
        document.getElementById('certificate-decision').classList.remove('hidden');
    } else {
        document.getElementById('certificate-decision').classList.add('hidden');
    }
    
    // Set details link
    document.getElementById('view-details-link').href = `/query/${query.id}`;
    
    // Re-enable form (for direct mode)
    if (currentGenerationMode === 'direct') {
        resetForm();
    }
}

function showErrorState(error) {
    document.getElementById('processing-state').classList.add('hidden');
    document.getElementById('results-state').classList.add('hidden');
    document.getElementById('error-state').classList.remove('hidden');
    
    document.getElementById('error-message').textContent = error;
    
    // Re-enable form
    resetForm();
}

function resetForm() {
    document.getElementById('submit-btn').disabled = false;
    document.getElementById('submit-btn').innerHTML = '<span class="material-icons">psychology</span> Generate Certificate';
    
    if (pollInterval) {
        clearInterval(pollInterval);
        pollInterval = null;
    }
    currentTaskId = null;
}

function showStatus(message, type) {
    // Simple status display - could be enhanced with a proper notification system
    const statusColor = type === 'success' ? 'var(--md-sys-color-primary)' : 'var(--md-sys-color-error)';
    console.log(`[${type.toUpperCase()}] ${message}`);
    
    // Could add a toast notification here
    if (type === 'error') {
        alert('Error: ' + message);
    }
}

function startPolling() {
    pollInterval = setInterval(async () => {
        if (!currentTaskId) return;
        
        try {
            const response = await fetch(`/task_status/${currentTaskId}`);
            const status = await response.json();
            
            // Handle task not found (cleaned up)
            if (status.status === 'not_found') {
                clearInterval(pollInterval);
                showErrorState('Task expired or was cleaned up. Please try again.');
                showStatus('Task not found. Please submit a new query.', 'error');
                return;
            }
            
            // Update progress
            document.getElementById('progress-bar').style.width = `${status.progress}%`;
            
            // Update status text
            const statusText = document.getElementById('processing-status');
            const detailText = document.getElementById('processing-detail');
            
            switch (status.status) {
                case 'processing':
                    statusText.textContent = 'Generating barrier certificate...';
                    detailText.textContent = 'Using LLM to generate certificate based on system description';
                    break;
                case 'generating':
                    statusText.textContent = 'Generating barrier certificate...';
                    detailText.textContent = 'Using LLM to generate certificate based on system description';
                    break;
                case 'verifying':
                    statusText.textContent = 'Verifying certificate...';
                    detailText.textContent = 'Running numerical, symbolic, and SOS verification checks';
                    break;
                case 'completed':
                    clearInterval(pollInterval);
                    showResultsState(status.query);
                    showStatus('Certificate generation completed!', 'success');
                    break;
                case 'failed':
                    clearInterval(pollInterval);
                    showErrorState(status.error || 'Task failed');
                    showStatus('Certificate generation failed', 'error');
                    break;
            }
        } catch (error) {
            console.error('Polling error:', error);
            // If we get repeated errors, stop polling
            if (error.message.includes('404') || error.message.includes('not found')) {
                clearInterval(pollInterval);
                showErrorState('Connection lost or task expired. Please try again.');
                showStatus('Lost connection to task. Please submit a new query.', 'error');
            }
        }
    }, 1000); // Poll every second
}

// ============ CONVERSATION FUNCTIONS ============

function switchMode(mode) {
    currentGenerationMode = mode;
    if (mode === 'direct') {
        document.getElementById('direct-panel').classList.remove('hidden');
        document.getElementById('conversation-panel').classList.add('hidden');
        document.getElementById('certificate-decision').classList.add('hidden');
    } else {
        document.getElementById('direct-panel').classList.add('hidden');
        document.getElementById('conversation-panel').classList.remove('hidden');
    }
}

async function startConversation() {
    try {
        const modelConfig = document.getElementById('conv-model-config').value;
        const ragK = parseInt(document.getElementById('conv-rag-k').value);
        
        const response = await fetch('/conversation/start', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                model_config: modelConfig,
                rag_k: ragK
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            currentSessionId = result.session_id;
            
            // Hide setup, show active conversation
            document.getElementById('conversation-setup').classList.add('hidden');
            document.getElementById('conversation-active').classList.remove('hidden');
            
            // Add initial message
            addMessageToChat(result.initial_message);
            
            showStatus('Conversation started successfully!', 'success');
        } else {
            showStatus('Failed to start conversation: ' + result.error, 'error');
        }
    } catch (error) {
        showStatus('Error starting conversation: ' + error.message, 'error');
    }
}

async function sendMessage() {
    const messageInput = document.getElementById('message-input');
    const message = messageInput.value.trim();
    
    if (!message || !currentSessionId) return;
    
    messageInput.value = '';
    document.getElementById('send-message-btn').disabled = true;
    
    // Add user message to chat
    addMessageToChat({
        role: 'user',
        content: message,
        timestamp: new Date().toISOString()
    });
    
    try {
        const response = await fetch(`/conversation/${currentSessionId}/message`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                message: message,
                message_type: 'chat'
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            // Add assistant response
            addMessageToChat(result.assistant_message);
        } else {
            showStatus('Failed to send message: ' + result.error, 'error');
        }
    } catch (error) {
        showStatus('Error sending message: ' + error.message, 'error');
    } finally {
        document.getElementById('send-message-btn').disabled = false;
    }
}

function addMessageToChat(message) {
    const chatMessages = document.getElementById('chat-messages');
    const messageDiv = document.createElement('div');
    messageDiv.className = `message message-${message.role}`;
    
    const timestamp = new Date(message.timestamp).toLocaleTimeString();
    
    messageDiv.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 4px;">
            <strong style="color: ${message.role === 'user' ? 'var(--md-sys-color-primary)' : 'var(--md-sys-color-secondary)'};">
                ${message.role === 'user' ? 'You' : 'AI Assistant'}
            </strong>
            <small style="color: var(--md-sys-color-on-surface-variant);">${timestamp}</small>
        </div>
        <div style="white-space: pre-wrap; line-height: 1.4;">${message.content}</div>
    `;
    
    messageDiv.style.marginBottom = '16px';
    messageDiv.style.padding = '12px';
    messageDiv.style.borderRadius = '8px';
    messageDiv.style.backgroundColor = message.role === 'user' 
        ? 'var(--md-sys-color-primary-container)' 
        : 'var(--md-sys-color-secondary-container)';
    
    chatMessages.appendChild(messageDiv);
    
    // Scroll to bottom
    const chatContainer = document.getElementById('chat-container');
    chatContainer.scrollTop = chatContainer.scrollHeight;
}

async function setReadyToGenerate(ready) {
    if (!currentSessionId) return;
    
    try {
        const response = await fetch(`/conversation/${currentSessionId}/ready`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ ready: ready })
        });
        
        const result = await response.json();
        
        if (result.success) {
            document.getElementById('generate-from-conversation-btn').disabled = !ready;
        } else {
            showStatus('Failed to update ready status: ' + result.error, 'error');
        }
    } catch (error) {
        showStatus('Error updating ready status: ' + error.message, 'error');
    }
}

async function generateFromConversation() {
    if (!currentSessionId) return;
    
    try {
        // Show processing state
        showProcessingState();
        
        const response = await fetch(`/conversation/${currentSessionId}/generate`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                // Could include verification parameters here
                attempt_sos: true,
                attempt_optimization: false
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            currentTaskId = result.task_id;
            currentQueryId = result.query_id;
            startPolling();
        } else {
            showErrorState(result.error || 'Failed to generate certificate from conversation');
        }
    } catch (error) {
        showErrorState('Error generating certificate: ' + error.message);
    }
}

async function acceptCertificate() {
    if (!currentSessionId || !currentQueryId) return;
    
    try {
        const response = await fetch(`/conversation/${currentSessionId}/accept_certificate/${currentQueryId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showStatus('Certificate accepted successfully!', 'success');
            document.getElementById('certificate-decision').classList.add('hidden');
        } else {
            showStatus('Failed to accept certificate: ' + result.error, 'error');
        }
    } catch (error) {
        showStatus('Error accepting certificate: ' + error.message, 'error');
    }
}

async function rejectCertificate() {
    if (!currentSessionId || !currentQueryId) return;
    
    try {
        const response = await fetch(`/conversation/${currentSessionId}/reject_certificate/${currentQueryId}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });
        
        const result = await response.json();
        
        if (result.success) {
            showStatus('Certificate rejected. You can continue the conversation.', 'success');
            document.getElementById('certificate-decision').classList.add('hidden');
            document.getElementById('ready-to-generate').checked = false;
            document.getElementById('generate-from-conversation-btn').disabled = true;
            
            // Clear results and return to conversation
            document.getElementById('results-state').classList.add('hidden');
            document.getElementById('initial-state').classList.remove('hidden');
        } else {
            showStatus('Failed to reject certificate: ' + result.error, 'error');
        }
    } catch (error) {
        showStatus('Error rejecting certificate: ' + error.message, 'error');
    }
}

// ============ END CONVERSATION FUNCTIONS ============

// Enhanced RAG Configuration Functions
let researchers = [];
let selectedResearchers = new Set();
let selectedTopics = new Set();

async function loadResearchers() {
    try {
        const response = await fetch('/api/researchers');
        if (response.ok) {
            researchers = await response.json();
            populateResearcherGrid();
        } else {
            console.error('Failed to load researchers');
        }
    } catch (error) {
        console.error('Error loading researchers:', error);
        // Fallback to demo data if API fails
        researchers = [
            {
                scholar_id: "mFdINk4AAAAJ",
                name: "Majid Zamani",
                institution: "University of Colorado Boulder",
                research_focus: "Cyber-physical systems; Hybrid systems; Control theory; Barrier certificates"
            },
            {
                scholar_id: "TjWwqmwAAAAJ",
                name: "Aaron D. Ames",
                institution: "California Institute of Technology", 
                research_focus: "Control Barrier Functions; Robotics; Nonlinear Control"
            },
            {
                scholar_id: "5_ksIkAAAAJ",
                name: "Claire J. Tomlin",
                institution: "University of California Berkeley",
                research_focus: "Control Theory; Hybrid Systems; Formal Verification"
            }
        ];
        populateResearcherGrid();
    }
}

function populateResearcherGrid() {
    const grid = document.getElementById('researcher-grid');
    if (!grid) return;
    
    grid.innerHTML = researchers.map(researcher => `
        <div class="researcher-card" onclick="toggleResearcher('${researcher.scholar_id}')" data-id="${researcher.scholar_id}">
            <input type="checkbox" 
                   id="researcher-${researcher.scholar_id}" 
                   onchange="updateResearcherSelection('${researcher.scholar_id}')"
                   ${selectedResearchers.has(researcher.scholar_id) ? 'checked' : ''}>
            <div class="researcher-info">
                <h4 class="researcher-name">${researcher.name}</h4>
                <p class="researcher-institution">${researcher.institution}</p>
                <p class="researcher-focus">${researcher.research_focus}</p>
            </div>
        </div>
    `).join('');
    
    updateResearcherCount();
}

function toggleResearcher(scholarId) {
    const checkbox = document.getElementById(`researcher-${scholarId}`);
    checkbox.checked = !checkbox.checked;
    updateResearcherSelection(scholarId);
}

function updateResearcherSelection(scholarId) {
    const checkbox = document.getElementById(`researcher-${scholarId}`);
    const card = checkbox.closest('.researcher-card');
    
    if (checkbox.checked) {
        selectedResearchers.add(scholarId);
        card.classList.add('selected');
    } else {
        selectedResearchers.delete(scholarId);
        card.classList.remove('selected');
    }
    
    updateResearcherCount();
    updateDatasetPreview();
}

function selectAllResearchers() {
    researchers.forEach(researcher => {
        selectedResearchers.add(researcher.scholar_id);
        const checkbox = document.getElementById(`researcher-${researcher.scholar_id}`);
        const card = checkbox.closest('.researcher-card');
        checkbox.checked = true;
        card.classList.add('selected');
    });
    updateResearcherCount();
    updateDatasetPreview();
}

function clearAllResearchers() {
    selectedResearchers.clear();
    researchers.forEach(researcher => {
        const checkbox = document.getElementById(`researcher-${researcher.scholar_id}`);
        const card = checkbox.closest('.researcher-card');
        checkbox.checked = false;
        card.classList.remove('selected');
    });
    updateResearcherCount();
    updateDatasetPreview();
}

function updateResearcherCount() {
    const countElement = document.getElementById('selected-researchers-count');
    if (countElement) {
        countElement.textContent = selectedResearchers.size;
    }
}

function toggleRagConfig() {
    const configDiv = document.getElementById('rag-dataset-config');
    const toggleBtn = document.getElementById('rag-config-toggle');
    const icon = toggleBtn.querySelector('.material-icons');
    
    if (configDiv.style.display === 'none' || !configDiv.style.display) {
        configDiv.style.display = 'block';
        toggleBtn.classList.add('expanded');
        icon.textContent = 'expand_less';
        toggleBtn.innerHTML = '<span class="material-icons">expand_less</span>Hide RAG Configuration';
        
        // Load researchers if not already loaded
        if (researchers.length === 0) {
            loadResearchers();
        }
        updateDatasetPreview();
    } else {
        configDiv.style.display = 'none';
        toggleBtn.classList.remove('expanded');
        icon.textContent = 'expand_more';
        toggleBtn.innerHTML = '<span class="material-icons">expand_more</span>Advanced RAG Configuration';
    }
}

function handleDatasetTypeChange() {
    const datasetType = document.getElementById('rag-dataset-type').value;
    const researcherSelection = document.getElementById('researcher-selection');
    const topicFiltering = document.getElementById('topic-filtering');
    
    if (datasetType === 'custom') {
        researcherSelection.style.display = 'block';
        topicFiltering.style.display = 'block';
    } else {
        researcherSelection.style.display = 'none';
        topicFiltering.style.display = 'none';
    }
    
    updateDatasetPreview();
}

function handleTopicChange() {
    selectedTopics.clear();
    document.querySelectorAll('input[name="topics"]:checked').forEach(checkbox => {
        selectedTopics.add(checkbox.value);
    });
    updateDatasetPreview();
}

async function updateDatasetPreview() {
    const paperCountElement = document.getElementById('paper-count');
    const chunkCountElement = document.getElementById('chunk-count');
    const qualityScoreElement = document.getElementById('quality-score');
    
    if (!paperCountElement || !chunkCountElement || !qualityScoreElement) return;
    
    // Show loading state
    paperCountElement.textContent = 'Loading...';
    chunkCountElement.textContent = 'Loading...';
    qualityScoreElement.textContent = '--';
    
    try {
        const datasetType = document.getElementById('rag-dataset-type')?.value || 'unified';
        
        const requestData = {
            dataset_type: datasetType,
            selected_researchers: Array.from(selectedResearchers),
            selected_topics: Array.from(selectedTopics)
        };
        
        const response = await fetch('/api/rag/preview', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(requestData)
        });
        
        if (response.ok) {
            const data = await response.json();
            paperCountElement.textContent = data.paper_count || 0;
            chunkCountElement.textContent = data.chunk_count || 0;
            qualityScoreElement.textContent = data.quality_score || '--';
        } else {
            // Fallback to demo data
            const demoStats = getDemoDatasetStats(datasetType);
            paperCountElement.textContent = demoStats.papers;
            chunkCountElement.textContent = demoStats.chunks;
            qualityScoreElement.textContent = demoStats.quality;
        }
    } catch (error) {
        console.error('Error updating dataset preview:', error);
        // Fallback to demo data
        const demoStats = getDemoDatasetStats(document.getElementById('rag-dataset-type')?.value || 'unified');
        paperCountElement.textContent = demoStats.papers;
        chunkCountElement.textContent = demoStats.chunks;
        qualityScoreElement.textContent = demoStats.quality;
    }
}

function getDemoDatasetStats(datasetType) {
    const stats = {
        unified: { papers: 156, chunks: 3240, quality: 87 },
        discrete: { papers: 45, chunks: 920, quality: 82 },
        continuous: { papers: 98, chunks: 2010, quality: 89 },
        custom: { papers: selectedResearchers.size * 5, chunks: selectedResearchers.size * 75, quality: 85 }
    };
    return stats[datasetType] || stats.unified;
}

function getRAGConfiguration() {
    const ragConfig = {
        rag_k: parseInt(document.getElementById('conv-rag-k')?.value || 3),
        dataset_type: document.getElementById('rag-dataset-type')?.value || 'unified',
        selected_researchers: Array.from(selectedResearchers),
        selected_topics: Array.from(selectedTopics)
    };
    
    return ragConfig;
}

// Event listeners for RAG configuration
document.addEventListener('DOMContentLoaded', function() {
    // Dataset type change handler
    const datasetTypeSelect = document.getElementById('rag-dataset-type');
    if (datasetTypeSelect) {
        datasetTypeSelect.addEventListener('change', handleDatasetTypeChange);
    }
    
    // Topic checkboxes change handler
    document.querySelectorAll('input[name="topics"]').forEach(checkbox => {
        checkbox.addEventListener('change', handleTopicChange);
    });
    
    // RAG K value change handler
    const ragKSelect = document.getElementById('conv-rag-k');
    if (ragKSelect) {
        ragKSelect.addEventListener('change', function() {
            const ragConfigDiv = document.getElementById('rag-dataset-config');
            if (parseInt(this.value) > 0) {
                // Show toggle button when RAG is enabled
                document.getElementById('rag-config-toggle').style.display = 'flex';
            } else {
                // Hide config when RAG is disabled
                document.getElementById('rag-config-toggle').style.display = 'none';
                if (ragConfigDiv) {
                    ragConfigDiv.style.display = 'none';
                }
            }
        });
    }
});

// Integration with existing functions
const originalStartConversation = startConversation;
startConversation = async function() {
    try {
        const modelConfig = document.getElementById('conv-model-config').value;
        const ragConfig = getRAGConfiguration();
        
        const response = await fetch('/conversation/start', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                model_config: modelConfig,
                rag_config: ragConfig
            })
        });
        
        const result = await response.json();
        
        if (result.success) {
            currentSessionId = result.session_id;
            
            // Hide setup, show active conversation
            document.getElementById('conversation-setup').classList.add('hidden');
            document.getElementById('conversation-active').classList.remove('hidden');
            
            // Add initial message
            addMessageToChat(result.initial_message);
            
            showStatus('Conversation started successfully!', 'success');
        } else {
            showStatus('Failed to start conversation: ' + result.error, 'error');
        }
    } catch (error) {
        showStatus('Error starting conversation: ' + error.message, 'error');
    }
};
</script>
{% endblock %} 